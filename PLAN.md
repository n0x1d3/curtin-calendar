# PLAN.md — Infrastructure: bun migration + test framework

_Last updated: 2026-02-28_
_Status: APPROVED_
_Spec: See SPEC.md (APPROVED 2026-02-27)_

## Approach

Two tracks executed in order:
1. **bun migration** — delete npm lockfile, run `bun install`, fix all `npm run` references in source files
2. **Vitest setup** — install deps, create config, write test files

No application logic is changed. All edits are infrastructure-only.

---

## Files to Change

| File | Change |
|------|--------|
| `package.json` | Fix `repack`/`repack:beta` scripts; add `test`, `test:watch`, `coverage` scripts; add vitest devDeps |
| `README.md` | Contributing section: `npm i` → `bun install`, `npm run watch` → `bun run watch` |
| `pack.beta.js` | Line 2 comment: `npm run repack:beta` → `bun run repack:beta`; line 36 error: `npm run build:beta` → `bun run build:beta` |

## Files to Create

| File | Purpose |
|------|---------|
| `vitest.config.ts` | Vitest configuration with coverage thresholds |
| `src/utils/format/formatData.test.ts` | Tests for `convertTime` |
| `src/utils/format/getDates.test.ts` | Tests for `getDates` and `getSemesterWeeks` |
| `bun.lock` | Generated by `bun install` — must be committed |

## Files to Delete

| File | Reason |
|------|--------|
| `package-lock.json` | Replaced by `bun.lock` |

---

## Implementation Steps

### Track 1 — bun migration

1. [ ] Delete `package-lock.json`
2. [ ] Run `bun install` → generates `bun.lock`
3. [ ] In `package.json` scripts, replace:
   - `"repack": "npm run build && npm run pack"` → `"repack": "bun run build && bun run pack"`
   - `"repack:beta": "npm run build:beta && node pack.beta.js"` → `"repack:beta": "bun run build:beta && node pack.beta.js"`
4. [ ] In `README.md` Contributing section, replace:
   - `Run \`npm i\` to install dependencies` → `Run \`bun install\` to install dependencies`
   - `Run \`npm run watch\` to build in watch mode` → `Run \`bun run watch\` to build in watch mode`
5. [ ] In `pack.beta.js`:
   - Line 2: `// Run via: npm run repack:beta` → `// Run via: bun run repack:beta`
   - Line 36: `'...Make sure you ran npm run build:beta first.'` → `'...Make sure you ran bun run build:beta first.'`
6. [ ] Verify: `grep -RInE "npm run|npm install|npm i([[:space:]]|$)|npm ci|npx " --exclude-dir=node_modules --exclude-dir=build --exclude-dir=build-beta --exclude-dir=release --exclude="SPEC.md" --exclude="AGENTS.md" --exclude="MEMORY.md" --exclude="PLAN.md" .` → no output

### Track 2 — Vitest setup

7. [ ] Install deps with exact versions: `bun add -d --exact vitest@4.0.18 @vitest/coverage-v8@4.0.18`; verify `package.json` shows `"vitest": "4.0.18"` and `"@vitest/coverage-v8": "4.0.18"` (no caret)
8. [ ] Add scripts to `package.json`:
   ```json
   "test": "TZ=UTC vitest run",
   "test:watch": "TZ=UTC vitest",
   "coverage": "TZ=UTC vitest run --coverage"
   ```
9. [ ] Create `vitest.config.ts`:
   ```typescript
   import { defineConfig } from 'vitest/config';

   export default defineConfig({
     test: {
       environment: 'node',
       include: ['src/**/*.test.ts'],
       coverage: {
         provider: 'v8',
         include: [
           'src/utils/format/formatData.ts',
           'src/utils/format/getDates.ts',
         ],
         reporter: ['text'],
         thresholds: {
           perFile: true,
           lines: 80,
           functions: 80,
         },
       },
     },
   });
   ```
10. [ ] Create `src/utils/format/formatData.test.ts`:
    ```typescript
    import { describe, it, expect } from 'vitest';
    import { convertTime } from './formatData';

    describe('convertTime', () => {
      it('standard am range', () => {
        const r = convertTime('9:00am - 10:00am');
        expect(r.start).toEqual({ hour: 9, minutes: 0 });
        expect(r.end).toEqual({ hour: 10, minutes: 0 });
        expect(r.differenceInMinutes).toBe(60);
      });

      it('standard pm range', () => {
        const r = convertTime('2:30pm - 3:30pm');
        expect(r.start).toEqual({ hour: 14, minutes: 30 });
        expect(r.end).toEqual({ hour: 15, minutes: 30 });
        expect(r.differenceInMinutes).toBe(60);
      });

      it('midnight boundary: 12:00am is hour 0', () => {
        const r = convertTime('12:00am - 1:00am');
        expect(r.start).toEqual({ hour: 0, minutes: 0 });
        expect(r.end).toEqual({ hour: 1, minutes: 0 });
        expect(r.differenceInMinutes).toBe(60);
      });

      it('noon boundary: 12:00pm is hour 12', () => {
        const r = convertTime('12:00pm - 1:00pm');
        expect(r.start).toEqual({ hour: 12, minutes: 0 });
        expect(r.end).toEqual({ hour: 13, minutes: 0 });
        expect(r.differenceInMinutes).toBe(60);
      });
    });
    ```
11. [ ] Create `src/utils/format/getDates.test.ts`:
    ```typescript
    import { describe, it, expect } from 'vitest';
    import { getDates, getSemesterWeeks } from './getDates';

    describe('getDates', () => {
      it('2025 — pre-2026 calculated path', () => {
        const d = getDates(2025);
        expect(d[1].start).toEqual({ month: 2, day: 24 });
        expect(d[1].end).toEqual({ month: 5, day: 25 });
        expect(d[1].weeks).toBe(13);
        expect(d[2].start).toEqual({ month: 7, day: 21 });
        expect(d[2].end).toEqual({ month: 10, day: 19 });
        expect(d[2].weeks).toBe(13);
        expect(d[1].start.month).toBeLessThanOrEqual(d[1].end.month);
        expect(d[1].weeks).toBeGreaterThan(0);
      });

      it('2026 — lookup table path', () => {
        const d = getDates(2026);
        expect(d[1].start).toEqual({ month: 2, day: 16 });
        expect(d[1].end).toEqual({ month: 5, day: 22 });
        expect(d[1].weeks).toBe(14);
        expect(d[2].start).toEqual({ month: 7, day: 20 });
        expect(d[2].end).toEqual({ month: 10, day: 23 });
        expect(d[2].weeks).toBe(14);
        expect(d[1].start.month).toBeLessThanOrEqual(d[1].end.month);
        expect(d[1].weeks).toBeGreaterThan(0);
      });

      it('2029 — post-2028 calculated path', () => {
        const d = getDates(2029);
        expect(d[1].start).toEqual({ month: 2, day: 19 });
        expect(d[1].end).toEqual({ month: 5, day: 27 });
        expect(d[1].weeks).toBe(14);
        expect(d[2].start).toEqual({ month: 7, day: 16 });
        expect(d[2].end).toEqual({ month: 10, day: 21 });
        expect(d[2].weeks).toBe(14);
        expect(d[1].start.month).toBeLessThanOrEqual(d[1].end.month);
        expect(d[1].weeks).toBeGreaterThan(0);
      });
    });

    describe('getSemesterWeeks', () => {
      it('2025 — pre-2026: both semesters → 13', () => {
        expect(getSemesterWeeks(2025, 1)).toBe(13);
        expect(getSemesterWeeks(2025, 2)).toBe(13);
      });

      it('2026 — lookup table: both semesters → 14', () => {
        expect(getSemesterWeeks(2026, 1)).toBe(14);
        expect(getSemesterWeeks(2026, 2)).toBe(14);
      });

      it('2029 — post-2028 calculated: both semesters → 14', () => {
        expect(getSemesterWeeks(2029, 1)).toBe(14);
        expect(getSemesterWeeks(2029, 2)).toBe(14);
      });
    });
    ```

---

## Edge Cases

- `bun install` with `package-lock.json` still present: delete it first — bun respects existing lockfiles and may behave unexpectedly if both exist
- `vitest.config.ts` is TypeScript but the project's `tsconfig.json` targets `commonjs` — vitest uses its own esbuild transform and does not run `tsc`, so no conflict
- `formatData.ts` imports from `'../../types'` which may reference Chrome type definitions — vitest's node environment does not load `@types/chrome` globally; TypeScript type checking is not run by vitest, so this is safe
- `getDates.ts` uses `new Date("February 1, ${year}")` (locale string constructor) — `TZ=UTC` in the test script ensures consistent date parsing across machines

---

## Testing

- [ ] `rm -f package-lock.json && bun install` — exits 0, `bun.lock` present in working tree
- [ ] `git status` shows `bun.lock` as a new untracked/staged file and `package-lock.json` as deleted — both staged in the commit
- [ ] `bun run test:watch` — starts Vitest in watch mode, outputs "waiting for file changes…" or equivalent, no config errors (Ctrl-C to exit)
- [ ] `rm -rf build/ && bun run build` — exits 0, `build/` contains popup.js, background.js, contentScript.js, readTable.js
- [ ] `bun run test` — exits 0, all tests pass
- [ ] `bun run coverage` — exits 0, ≥80% lines and functions per file for both target files
- [ ] npm reference grep — no output

---

## Review History

| Round | Reviewer | Verdict | Date |
|-------|----------|---------|------|
| 1 | gpt-5.3-codex | NEEDS FIXES | 2026-02-28 |
| 2 | gpt-5.3-codex | NEEDS FIXES | 2026-02-28 |
| 3 | gpt-5.3-codex | APPROVED | 2026-02-28 |
